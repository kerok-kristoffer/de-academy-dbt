USE ROLE ACCOUNTADMIN;
USE WAREHOUSE COMPUTE_WH;

CREATE OR REPLACE DATABASE SCD2_DB;


GRANT ALL PRIVILEGES ON SCHEMA SCD2_DB.BRONZE TO ROLE USERADMIN;


USE SCHEMA SCD2_DB.BRONZE;

 

CREATE STORAGE INTEGRATION SCD2_INT
  TYPE = EXTERNAL_STAGE
  STORAGE_PROVIDER = 'S3'
  ENABLED = TRUE
  STORAGE_AWS_ROLE_ARN = '<role>'
  STORAGE_ALLOWED_LOCATIONS = ('<bucket>');

  DESC INTEGRATION SCD2_INT;
    -- added integration info to AWS role trust_policy



  CREATE OR REPLACE FILE FORMAT MY_CSV_FORMAT
  TYPE = CSV
  FIELD_DELIMITER = ','
  FIELD_OPTIONALLY_ENCLOSED_BY = '"'
  SKIP_HEADER = 1
  NULL_IF = ('NULL', 'null')
  EMPTY_FIELD_AS_NULL = true;


CREATE STAGE SCD2_S3_STAGE
  STORAGE_INTEGRATION = SCD2_INT
  URL = '<bucket>'
  FILE_FORMAT = MY_CSV_FORMAT;

ls @SCD2_S3_STAGE;




GRANT ALL PRIVILEGES ON SCHEMA SCD2_DB.BRONZE TO ROLE PC_DBT_ROLE;
GRANT ALL PRIVILEGES ON SCHEMA SCD2_DB.SILVER TO ROLE PC_DBT_ROLE;
GRANT ALL PRIVILEGES ON SCHEMA SCD2_DB.GOLD TO ROLE PC_DBT_ROLE;



CREATE OR REPLACE TABLE 
    SCD2_DB.BRONZE.WORK_PRODUCT_COPY
(
    PRODUCT_ID VARCHAR(255) NOT NULL COLLATE 'en-ci'
    ,PRODUCT_NAME VARCHAR(255) NOT NULL COLLATE 'en-ci'
    ,CATEGORY VARCHAR(255) COLLATE 'en-ci'
    ,SELLING_PRICE VARCHAR(50) COLLATE 'en-ci'
    ,MODEL_NUMBER VARCHAR(50) COLLATE 'en-ci'
    ,ABOUT_PRODUCT VARCHAR(5000) COLLATE 'en-ci'
    ,PRODUCT_SPECIFICATION VARCHAR(5000) COLLATE 'en-ci'
    ,TECHNICAL_DETAILS VARCHAR(50000) COLLATE 'en-ci'
    ,SHIPPING_WEIGHT VARCHAR(30) COLLATE 'en-ci'
    ,PRODUCT_DIMENSIONS VARCHAR(100) COLLATE 'en-ci'
    ,INSERT_DTS TIMESTAMP_NTZ(6) NOT NULL
    ,UPDATE_DTS TIMESTAMP_NTZ(6) NOT NULL
    ,SOURCE_FILE_NAME VARCHAR(255) NOT NULL
    ,SOURCE_FILE_ROW_NUMBER VARCHAR(255) NOT NULL);


SELECT * FROM SCD2_DB.SNAPSHOTS.PRODUCT_SNAPSHOT;

select * from SCD2_DB.GOLD.PRODUCT_VIEW;

-- uploaded the second file to S3 and ran the models again

select * from SCD2_DB.GOLD.PRODUCT_VIEW
WHERE PRODUCT_ID = '4c69b61db1fc16e7013b43fc926e502d';



 
